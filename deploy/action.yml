name: 'Base Deploy'
description: 'Deploy to Norce Base Platform'
author: 'NorceTech'

branding:
  icon: 'upload-cloud'
  color: 'blue'

inputs:
  environment:
    description: 'Target environment (stage, prod, dev, qa, etc.)'
    required: true
  image_tag:
    description: 'Image tag to deploy'
    required: true
  customer:
    description: 'Customer name (defaults to repository name)'
    required: false
  config_file:
    description: 'Path to config file'
    required: false
    default: '.base/config.yaml'
  api_url:
    description: 'Base Platform API URL'
    required: false
    default: 'https://base-api.norce.tech'
  api_key:
    description: 'Base Platform API key (identifies partner)'
    required: true
  wait_for_healthy:
    description: 'Wait for deployment to become healthy (true/false)'
    required: false
    default: 'true'
  wait_timeout:
    description: 'Timeout in seconds when waiting for healthy status'
    required: false
    default: '300'

outputs:
  success:
    description: 'Whether the deployment was successful'
    value: ${{ steps.final-status.outputs.success }}
  namespace:
    description: 'Kubernetes namespace'
    value: ${{ steps.deploy.outputs.namespace }}
  git_commit_sha:
    description: 'Git commit SHA in GitOps repo'
    value: ${{ steps.deploy.outputs.git_commit_sha }}
  previous_image_tag:
    description: 'Previous image tag'
    value: ${{ steps.deploy.outputs.previous_image_tag }}
  message:
    description: 'Deployment message'
    value: ${{ steps.final-status.outputs.message }}
  health_status:
    description: 'Final health status (Healthy, Progressing, Degraded, etc.)'
    value: ${{ steps.wait-healthy.outputs.health_status }}
  sync_status:
    description: 'Final sync status (Synced, OutOfSync, etc.)'
    value: ${{ steps.wait-healthy.outputs.sync_status }}

runs:
  using: 'composite'
  steps:
    - name: Read configuration
      id: config
      shell: bash
      env:
        CONFIG_FILE: ${{ inputs.config_file }}
        ENVIRONMENT: ${{ inputs.environment }}
      run: |
        if [ -f "$CONFIG_FILE" ]; then
          echo "Found config file: $CONFIG_FILE"
          if command -v yq &> /dev/null; then
            ENV_CONFIG=$(yq -o=json -I=0 ".environments.$ENVIRONMENT // {}" "$CONFIG_FILE")
          else
            ENV_CONFIG=$(python3 -c "
        import yaml, json, os, sys
        with open(os.environ['CONFIG_FILE']) as f:
            data = yaml.safe_load(f)
            env_config = data.get('environments', {}).get(os.environ['ENVIRONMENT'], {})
            print(json.dumps(env_config, separators=(',', ':')))
        " 2>/dev/null || echo "{}")
          fi
          echo "config=$ENV_CONFIG" >> $GITHUB_OUTPUT
        else
          echo "No config file found, using defaults"
          echo "config={}" >> $GITHUB_OUTPUT
        fi

    - name: Deploy to Base Platform
      id: deploy
      shell: bash
      env:
        API_URL: ${{ inputs.api_url }}
        API_KEY: ${{ inputs.api_key }}
        CUSTOMER: ${{ inputs.customer || github.event.repository.name }}
        ENVIRONMENT: ${{ inputs.environment }}
        IMAGE_TAG: ${{ inputs.image_tag }}
        COMMIT_SHA: ${{ github.sha }}
        CONFIG: ${{ steps.config.outputs.config }}
      run: |
        BODY=$(jq -n \
          --arg action "deploy" \
          --arg customer "$CUSTOMER" \
          --arg environment "$ENVIRONMENT" \
          --arg image_tag "$IMAGE_TAG" \
          --arg commit_sha "$COMMIT_SHA" \
          '{
            action: $action,
            customer: $customer,
            environment: $environment,
            image_tag: $image_tag,
            commit_sha: $commit_sha
          }')

        if [ -n "$CONFIG" ] && [ "$CONFIG" != "{}" ]; then
          BODY=$(echo "$BODY" | jq --argjson config "$CONFIG" '. + {config: $config}' 2>/dev/null || echo "$BODY")
        fi

        echo "Request body: $BODY"

        RESPONSE=$(curl -s -w "\n%{http_code}" -X POST "${API_URL}/api/v1/deploy" \
          -H "Authorization: Bearer ${API_KEY}" \
          -H "Content-Type: application/json" \
          -d "$BODY")

        HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
        BODY=$(echo "$RESPONSE" | sed '$d')

        echo "Response: $HTTP_CODE"

        if [ "$HTTP_CODE" -ne 200 ]; then
          echo "::error::Deployment failed"
          echo "$BODY" | jq . 2>/dev/null || echo "$BODY"
          echo "success=false" >> $GITHUB_OUTPUT
          echo "deploy_success=false" >> $GITHUB_OUTPUT
          exit 1
        fi

        SUCCESS=$(echo "$BODY" | jq -r '.data.success // false')
        NAMESPACE=$(echo "$BODY" | jq -r '.data.namespace // empty')
        GIT_SHA=$(echo "$BODY" | jq -r '.data.gitCommitSha // empty')
        PREV_TAG=$(echo "$BODY" | jq -r '.data.previousImageTag // empty')
        MESSAGE=$(echo "$BODY" | jq -r '.data.message // empty')

        echo "success=$SUCCESS" >> $GITHUB_OUTPUT
        echo "deploy_success=$SUCCESS" >> $GITHUB_OUTPUT
        echo "namespace=$NAMESPACE" >> $GITHUB_OUTPUT
        echo "git_commit_sha=$GIT_SHA" >> $GITHUB_OUTPUT
        echo "previous_image_tag=$PREV_TAG" >> $GITHUB_OUTPUT
        echo "message=$MESSAGE" >> $GITHUB_OUTPUT

        echo "✓ GitOps repo updated: ${IMAGE_TAG} → ${ENVIRONMENT}"
        echo "$MESSAGE"

    - name: Wait for healthy deployment
      id: wait-healthy
      if: ${{ inputs.wait_for_healthy == 'true' && steps.deploy.outputs.deploy_success == 'true' }}
      shell: bash
      env:
        API_URL: ${{ inputs.api_url }}
        API_KEY: ${{ inputs.api_key }}
        CUSTOMER: ${{ inputs.customer || github.event.repository.name }}
        ENVIRONMENT: ${{ inputs.environment }}
        IMAGE_TAG: ${{ inputs.image_tag }}
        TIMEOUT: ${{ inputs.wait_timeout }}
      run: |
        echo "⏳ Waiting for deployment to become healthy (timeout: ${TIMEOUT}s)..."

        START_TIME=$(date +%s)
        POLL_INTERVAL=10
        LAST_STATUS=""

        while true; do
          CURRENT_TIME=$(date +%s)
          ELAPSED=$((CURRENT_TIME - START_TIME))

          if [ $ELAPSED -ge $TIMEOUT ]; then
            echo "::error::Timeout waiting for deployment to become healthy after ${TIMEOUT}s"
            echo "health_status=Timeout" >> $GITHUB_OUTPUT
            echo "sync_status=Unknown" >> $GITHUB_OUTPUT
            echo "healthy=false" >> $GITHUB_OUTPUT
            exit 1
          fi

          RESPONSE=$(curl -s -w "\n%{http_code}" \
            "${API_URL}/api/v1/deploy/status?customer=${CUSTOMER}&environment=${ENVIRONMENT}" \
            -H "Authorization: Bearer ${API_KEY}")

          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | sed '$d')

          if [ "$HTTP_CODE" -ne 200 ]; then
            echo "  Warning: Failed to get deployment status (HTTP $HTTP_CODE), retrying..."
            sleep $POLL_INTERVAL
            continue
          fi

          HEALTH=$(echo "$BODY" | jq -r '.data.healthStatus // "Unknown"')
          SYNC=$(echo "$BODY" | jq -r '.data.syncStatus // "Unknown"')
          CURRENT_TAG=$(echo "$BODY" | jq -r '.data.imageTag // "unknown"')

          STATUS_LINE="  [${ELAPSED}s] Health: ${HEALTH}, Sync: ${SYNC}, Tag: ${CURRENT_TAG}"

          if [ "$STATUS_LINE" != "$LAST_STATUS" ]; then
            echo "$STATUS_LINE"
            LAST_STATUS="$STATUS_LINE"
          fi

          if [ "$HEALTH" == "Healthy" ] && [ "$SYNC" == "Synced" ]; then
            if [ "$CURRENT_TAG" == "$IMAGE_TAG" ]; then
              echo ""
              echo "✅ Deployment healthy!"
              echo "   Health: $HEALTH"
              echo "   Sync: $SYNC"
              echo "   Image: $CURRENT_TAG"
              echo "   Time: ${ELAPSED}s"

              echo "health_status=$HEALTH" >> $GITHUB_OUTPUT
              echo "sync_status=$SYNC" >> $GITHUB_OUTPUT
              echo "healthy=true" >> $GITHUB_OUTPUT
              exit 0
            fi
          fi

          if [ "$HEALTH" == "Degraded" ] || [ "$HEALTH" == "Missing" ]; then
            echo ""
            echo "::error::Deployment failed - Health: $HEALTH"
            echo "health_status=$HEALTH" >> $GITHUB_OUTPUT
            echo "sync_status=$SYNC" >> $GITHUB_OUTPUT
            echo "healthy=false" >> $GITHUB_OUTPUT
            exit 1
          fi

          sleep $POLL_INTERVAL
        done

    - name: Set final status
      id: final-status
      if: always()
      shell: bash
      env:
        DEPLOY_SUCCESS: ${{ steps.deploy.outputs.deploy_success }}
        WAIT_ENABLED: ${{ inputs.wait_for_healthy }}
        HEALTHY: ${{ steps.wait-healthy.outputs.healthy }}
        HEALTH_STATUS: ${{ steps.wait-healthy.outputs.health_status }}
        DEPLOY_MESSAGE: ${{ steps.deploy.outputs.message }}
      run: |
        if [ "$DEPLOY_SUCCESS" != "true" ]; then
          echo "success=false" >> $GITHUB_OUTPUT
          echo "message=Deployment failed to update GitOps repo" >> $GITHUB_OUTPUT
          exit 0
        fi

        if [ "$WAIT_ENABLED" == "true" ]; then
          if [ "$HEALTHY" == "true" ]; then
            echo "success=true" >> $GITHUB_OUTPUT
            echo "message=Deployment complete and healthy" >> $GITHUB_OUTPUT
          else
            echo "success=false" >> $GITHUB_OUTPUT
            echo "message=Deployment failed - Health: ${HEALTH_STATUS:-Unknown}" >> $GITHUB_OUTPUT
          fi
        else
          echo "success=true" >> $GITHUB_OUTPUT
          echo "message=$DEPLOY_MESSAGE" >> $GITHUB_OUTPUT
        fi
