name: 'Base Deploy'
description: 'Deploy to Norce Base Platform'
author: 'NorceTech'

branding:
  icon: 'upload-cloud'
  color: 'blue'

inputs:
  environment:
    description: 'Target environment (e.g. stage, staging, prod, dev). Must match exactly the environment name in Base Portal.'
    required: true
  image_tag:
    description: 'Image tag to deploy'
    required: true
  customer:
    description: 'Customer name (defaults to repository name)'
    required: false
  image:
    description: 'Container image name (defaults to customer name). Use when the image name differs from the customer name.'
    required: false
  config_file:
    description: 'Path to config file'
    required: false
    default: '.base/config.yaml'
  api_url:
    description: 'Base Platform API URL'
    required: false
    default: 'https://base-api.norce.tech'
  api_key:
    description: 'Base Platform API key (identifies partner)'
    required: true
  wait_for_healthy:
    description: 'Wait for deployment to become healthy (true/false)'
    required: false
    default: 'true'
  wait_timeout:
    description: 'Timeout in seconds when waiting for healthy status'
    required: false
    default: '300'

outputs:
  success:
    description: 'Whether the deployment was successful'
    value: ${{ steps.final-status.outputs.success }}
  namespace:
    description: 'Kubernetes namespace'
    value: ${{ steps.deploy.outputs.namespace }}
  git_commit_sha:
    description: 'Git commit SHA for the deployment'
    value: ${{ steps.deploy.outputs.git_commit_sha }}
  previous_image_tag:
    description: 'Previous image tag'
    value: ${{ steps.deploy.outputs.previous_image_tag }}
  message:
    description: 'Deployment message'
    value: ${{ steps.final-status.outputs.message }}
  health_status:
    description: 'Final health status (Healthy, Progressing, Degraded, etc.)'
    value: ${{ steps.wait-healthy.outputs.health_status }}
  sync_status:
    description: 'Final sync status (Synced, OutOfSync, etc.)'
    value: ${{ steps.wait-healthy.outputs.sync_status }}

runs:
  using: 'composite'
  steps:
    - name: Deploy to Base Platform
      id: deploy
      shell: bash
      env:
        API_URL: ${{ inputs.api_url }}
        API_KEY: ${{ inputs.api_key }}
        CUSTOMER: ${{ inputs.customer || github.event.repository.name }}
        ENVIRONMENT: ${{ inputs.environment }}
        IMAGE_TAG: ${{ inputs.image_tag }}
        IMAGE: ${{ inputs.image }}
        COMMIT_SHA: ${{ github.sha }}
        CONFIG_FILE: ${{ inputs.config_file }}
        REPO_NAME: ${{ github.event.repository.name }}
      run: bash ${{ github.action_path }}/deploy.sh

    - name: Wait for healthy deployment
      id: wait-healthy
      if: ${{ inputs.wait_for_healthy == 'true' && steps.deploy.outputs.deploy_success == 'true' }}
      shell: bash
      env:
        API_URL: ${{ inputs.api_url }}
        API_KEY: ${{ inputs.api_key }}
        CUSTOMER: ${{ inputs.customer || github.event.repository.name }}
        ENVIRONMENT: ${{ inputs.environment }}
        IMAGE_TAG: ${{ inputs.image_tag }}
        TIMEOUT: ${{ inputs.wait_timeout }}
      run: bash ${{ github.action_path }}/wait-healthy.sh

    - name: Set final status
      id: final-status
      if: always()
      shell: bash
      env:
        DEPLOY_SUCCESS: ${{ steps.deploy.outputs.deploy_success }}
        WAIT_ENABLED: ${{ inputs.wait_for_healthy }}
        HEALTHY: ${{ steps.wait-healthy.outputs.healthy }}
        HEALTH_STATUS: ${{ steps.wait-healthy.outputs.health_status }}
        DEPLOY_MESSAGE: ${{ steps.deploy.outputs.message }}
      run: bash ${{ github.action_path }}/final-status.sh
